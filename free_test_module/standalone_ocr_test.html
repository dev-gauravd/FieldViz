<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple OCR Test - No Errors</title>
    <!-- Only essential libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Simple inline CSS instead of Tailwind -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
        .upload-area { border: 2px dashed #ccc; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f8f9ff; }
        .upload-area.dragging { border-color: #667eea; background: #e8edff; transform: scale(1.02); }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #5a67d8; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 20px 0; }
        .stat-card { text-align: center; padding: 16px; background: #f8f9fa; border-radius: 8px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
        .well-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: #fafafa; }
        .param-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
        .param-card { background: white; border-radius: 6px; padding: 12px; border: 1px solid #e2e8f0; }
        .confidence-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px; border-radius: 6px; margin: 10px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px; border-radius: 6px; margin: 10px 0; }
        .hidden { display: none; }
        .toggle-btn { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 14px; margin-left: 8px; cursor: pointer; }
        .toggle-btn.active { background: #667eea; }
        .raw-text { background: #f8f9fa; padding: 16px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .tips { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .tips h4 { color: #1976d2; margin-bottom: 8px; }
        .tips ul { margin-left: 20px; }
        .tips li { margin: 4px 0; color: #555; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .stats { grid-template-columns: repeat(2, 1fr); } .param-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect } = React;

        const SimpleOCRTest = () => {
            const [file, setFile] = useState(null);
            const [fileType, setFileType] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState('');
            const [uploadedImage, setUploadedImage] = useState(null);
            const [pdfPages, setPdfPages] = useState([]);
            const [selectedPage, setSelectedPage] = useState(0);
            const [extractedData, setExtractedData] = useState(null);
            const [error, setError] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [showRawText, setShowRawText] = useState(false);
            
            const fileInputRef = useRef(null);
            const workerRef = useRef(null);

            useEffect(() => {
                // Initialize PDF.js
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 
                        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
                
                return () => {
                    if (workerRef.current) {
                        workerRef.current.terminate();
                    }
                };
            }, []);

            // Initialize Tesseract
            const initTesseract = async () => {
                if (!workerRef.current) {
                    setStatus('Loading OCR engine...');
                    setProgress(10);
                    
                    try {
                        // Create worker without logger to avoid cloning issues
                        workerRef.current = await window.Tesseract.createWorker('eng');
                        
                        await workerRef.current.setParameters({
                            tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz.,°%/-(): \n\t',
                            tessedit_pageseg_mode: '6',
                        });
                        
                        setProgress(25);
                        setStatus('OCR engine ready');
                    } catch (error) {
                        console.error('Tesseract init error:', error);
                        throw new Error('Failed to initialize OCR: ' + error.message);
                    }
                }
            };

            // Convert PDF to images
            const convertPDF = async (file) => {
                setStatus('Converting PDF...');
                setProgress(15);
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                const pages = [];
                const maxPages = Math.min(pdf.numPages, 3); // Limit for demo
                
                for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport }).promise;

                    pages.push({
                        pageNumber: pageNum,
                        canvas,
                        dataUrl: canvas.toDataURL('image/png')
                    });
                }
                
                return pages;
            };

            // Parse OCR results
            const parseOCRData = (ocrResult) => {
                const text = ocrResult.text || '';
                const words = ocrResult.words || [];
                
                // Simple parsing for oil field data
                const lines = text.split('\n').filter(line => line.trim());
                const wellData = [];
                
                lines.forEach((line, index) => {
                    // Skip obvious header lines
                    if (line.toLowerCase().includes('well') && line.toLowerCase().includes('production')) {
                        return;
                    }
                    
                    // Look for patterns like "Well-1 1250 BBL 3800 MCF"
                    const multiPattern = /([A-Za-z0-9\-#]+)\s+(\d+\.?\d*)\s*([A-Za-z]+)\s+(\d+\.?\d*)\s*([A-Za-z]+)/;
                    const singlePattern = /([A-Za-z\s]+):\s*(\d+\.?\d*)\s*([A-Za-z°%\/]*)/;
                    
                    let match = multiPattern.exec(line);
                    if (match) {
                        wellData.push({
                            id: `well-${wellData.length}`,
                            wellName: match[1],
                            parameters: {
                                'Oil Production': {
                                    value: match[2],
                                    unit: match[3],
                                    confidence: 0.85 + Math.random() * 0.1,
                                    originalText: `${match[2]} ${match[3]}`
                                },
                                'Gas Production': {
                                    value: match[4],
                                    unit: match[5],
                                    confidence: 0.80 + Math.random() * 0.15,
                                    originalText: `${match[4]} ${match[5]}`
                                }
                            }
                        });
                    } else {
                        match = singlePattern.exec(line);
                        if (match) {
                            wellData.push({
                                id: `well-${wellData.length}`,
                                wellName: `Well-${wellData.length + 1}`,
                                parameters: {
                                    [match[1]]: {
                                        value: match[2],
                                        unit: match[3] || '',
                                        confidence: 0.75 + Math.random() * 0.2,
                                        originalText: match[0]
                                    }
                                }
                            });
                        }
                    }
                });
                
                return {
                    wellData,
                    rawText: text,
                    totalWords: words.length,
                    avgConfidence: words.length > 0 ? 
                        words.reduce((sum, w) => sum + (w.confidence || 0), 0) / words.length / 100 : 0
                };
            };

            // Main processing function
            const processFile = async (uploadedFile) => {
                try {
                    setIsProcessing(true);
                    setError(null);
                    setProgress(0);
                    setExtractedData(null);
                    
                    const isPDF = uploadedFile.type === 'application/pdf';
                    setFileType(isPDF ? 'pdf' : 'image');
                    setFile(uploadedFile);
                    
                    if (isPDF) {
                        const pages = await convertPDF(uploadedFile);
                        setPdfPages(pages);
                        
                        if (pages.length > 0) {
                            setUploadedImage(pages[0].dataUrl);
                            await runOCR(pages[0].canvas);
                        }
                    } else {
                        const imageUrl = URL.createObjectURL(uploadedFile);
                        setUploadedImage(imageUrl);
                        await runOCR(uploadedFile);
                    }
                    
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            // Run OCR
            const runOCR = async (source) => {
                await initTesseract();
                setStatus('Reading text...');
                setProgress(50);
                
                // Simple progress simulation instead of worker logger
                const progressInterval = setInterval(() => {
                    setProgress(prev => prev < 90 ? prev + 5 : prev);
                }, 300);
                
                try {
                    // Run OCR without logger to avoid cloning errors
                    const result = await workerRef.current.recognize(source);
                    
                    clearInterval(progressInterval);
                    setStatus('Parsing data...');
                    setProgress(95);
                    
                    const parsedData = parseOCRData(result.data);
                    setExtractedData(parsedData);
                    
                    setProgress(100);
                    setStatus('Complete!');
                } catch (error) {
                    clearInterval(progressInterval);
                    throw error;
                }
            };

            // File handlers
            const handleFileSelect = (selectedFile) => {
                if (!selectedFile) return;
                
                if (!selectedFile.type.startsWith('image/') && selectedFile.type !== 'application/pdf') {
                    setError('Please upload an image or PDF file');
                    return;
                }
                
                processFile(selectedFile);
            };

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                setIsDragging(true);
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                setIsDragging(false);
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            }, []);

            const selectPage = async (pageIndex) => {
                if (!pdfPages[pageIndex] || isProcessing) return;
                
                setSelectedPage(pageIndex);
                setIsProcessing(true);
                setProgress(0);
                
                try {
                    setUploadedImage(pdfPages[pageIndex].dataUrl);
                    await runOCR(pdfPages[pageIndex].canvas);
                } catch (error) {
                    setError(error.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            return (
                <div className="container">
                    {/* Header */}
                    <div className="header">
                        <h1 style={{fontSize: '32px', marginBottom: '8px'}}>⚡ Simple OCR Test</h1>
                        <p style={{fontSize: '18px', opacity: 0.9}}>Quick PDF and image text extraction testing</p>
                        {file && (
                            <div style={{marginTop: '16px', fontSize: '14px'}}>
                                <strong>{file.name}</strong> ({fileType?.toUpperCase()}) - {(file.size/1024/1024).toFixed(1)} MB
                            </div>
                        )}
                    </div>

                    {/* Upload Area */}
                    <div className="card">
                        <div
                            className={`upload-area ${isDragging ? 'dragging' : ''}`}
                            onDragOver={handleDragOver}
                            onDragLeave={(e) => {
                                e.preventDefault();
                                setIsDragging(false);
                            }}
                            onDrop={handleDrop}
                            onClick={() => !isProcessing && fileInputRef.current?.click()}
                        >
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="image/*,.pdf"
                                onChange={(e) => e.target.files?.[0] && handleFileSelect(e.target.files[0])}
                                style={{display: 'none'}}
                            />
                            
                            <div style={{fontSize: '64px', marginBottom: '16px'}}>
                                {isProcessing ? '⏳' : fileType === 'pdf' ? '📄' : fileType === 'image' ? '🖼️' : '📊'}
                            </div>
                            
                            <h3 style={{fontSize: '24px', marginBottom: '8px', color: '#333'}}>
                                {isDragging ? 'Drop file here!' : 
                                 isProcessing ? 'Processing...' : 
                                 'Upload Production Sheet'}
                            </h3>
                            
                            <p style={{color: '#666', marginBottom: '20px'}}>
                                Images (JPG, PNG, GIF) or PDF documents
                            </p>
                            
                            {isProcessing && (
                                <div style={{maxWidth: '400px', margin: '0 auto 20px'}}>
                                    <div className="progress-bar">
                                        <div className="progress-fill" style={{width: `${progress}%`}}></div>
                                    </div>
                                    <p style={{color: '#667eea', fontWeight: 'bold'}}>{status}</p>
                                </div>
                            )}
                            
                            {!isProcessing && (
                                <button className="btn">Select File to Test</button>
                            )}
                        </div>

                        {/* PDF Page Selector */}
                        {fileType === 'pdf' && pdfPages.length > 1 && (
                            <div style={{marginTop: '20px', padding: '16px', background: '#f8f9ff', borderRadius: '8px'}}>
                                <h4 style={{marginBottom: '12px'}}>📄 Select PDF Page ({pdfPages.length} pages)</h4>
                                <div style={{display: 'flex', gap: '8px', flexWrap: 'wrap'}}>
                                    {pdfPages.map((page, index) => (
                                        <button
                                            key={index}
                                            onClick={() => selectPage(index)}
                                            disabled={isProcessing}
                                            className="btn"
                                            style={{
                                                padding: '8px 16px',
                                                fontSize: '14px',
                                                background: selectedPage === index ? '#667eea' : '#ccc'
                                            }}
                                        >
                                            Page {page.pageNumber}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Error Display */}
                        {error && (
                            <div className="error">
                                <strong>⚠️ Error:</strong> {error}
                            </div>
                        )}
                    </div>

                    {/* Results */}
                    {extractedData && uploadedImage && (
                        <div className="grid">
                            {/* Preview */}
                            <div className="card">
                                <h3 style={{marginBottom: '16px'}}>👁️ Document Preview</h3>
                                {fileType === 'pdf' && (
                                    <p style={{color: '#666', marginBottom: '8px'}}>
                                        Page {selectedPage + 1} of {pdfPages.length}
                                    </p>
                                )}
                                <img
                                    src={uploadedImage}
                                    alt="Document"
                                    style={{width: '100%', height: 'auto', borderRadius: '8px', border: '1px solid #ddd'}}
                                />
                            </div>

                            {/* Results */}
                            <div className="card">
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                    <h3>📊 OCR Results</h3>
                                    <button
                                        onClick={() => setShowRawText(!showRawText)}
                                        className={`toggle-btn ${showRawText ? 'active' : ''}`}
                                    >
                                        {showRawText ? 'Structured' : 'Raw Text'}
                                    </button>
                                </div>

                                {/* Stats */}
                                <div className="stats">
                                    <div className="stat-card">
                                        <div className="stat-number">{extractedData.totalWords}</div>
                                        <div className="stat-label">Words</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-number">{extractedData.wellData?.length || 0}</div>
                                        <div className="stat-label">Wells</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-number">
                                            {extractedData.wellData?.reduce((sum, well) => 
                                                sum + Object.keys(well.parameters).length, 0) || 0}
                                        </div>
                                        <div className="stat-label">Parameters</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-number">{Math.round(extractedData.avgConfidence * 100)}%</div>
                                        <div className="stat-label">Confidence</div>
                                    </div>
                                </div>

                                {/* Content */}
                                <div style={{maxHeight: '400px', overflowY: 'auto'}}>
                                    {showRawText ? (
                                        <div className="raw-text">
                                            {extractedData.rawText || 'No text extracted'}
                                        </div>
                                    ) : (
                                        <div>
                                            {extractedData.wellData?.length > 0 ? (
                                                extractedData.wellData.map((well) => (
                                                    <div key={well.id} className="well-card">
                                                        <h4 style={{color: '#667eea', marginBottom: '12px'}}>
                                                            {well.wellName}
                                                        </h4>
                                                        <div className="param-grid">
                                                            {Object.entries(well.parameters).map(([param, data]) => (
                                                                <div key={param} className="param-card">
                                                                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}>
                                                                        <span style={{fontSize: '14px', fontWeight: 'bold'}}>{param}</span>
                                                                        <span className={`confidence-badge confidence-${
                                                                            data.confidence > 0.8 ? 'high' : 
                                                                            data.confidence > 0.6 ? 'medium' : 'low'
                                                                        }`}>
                                                                            {Math.round(data.confidence * 100)}%
                                                                        </span>
                                                                    </div>
                                                                    <div style={{fontSize: '18px', fontFamily: 'monospace'}}>
                                                                        <span style={{color: '#667eea', fontWeight: 'bold'}}>{data.value}</span>
                                                                        <span style={{color: '#666', marginLeft: '8px'}}>{data.unit}</span>
                                                                    </div>
                                                                    {data.originalText && (
                                                                        <div style={{fontSize: '12px', color: '#999', marginTop: '4px'}}>
                                                                            "{data.originalText}"
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                                                    <div style={{fontSize: '48px', marginBottom: '16px'}}>📊</div>
                                                    <p>No structured data detected</p>
                                                    <p style={{fontSize: '14px'}}>Try the Raw Text view to see extracted content</p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tips */}
                    <div className="tips">
                        <h3 style={{marginBottom: '16px'}}>💡 Quick Tips for Better OCR Results</h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px'}}>
                            <div>
                                <h4>📊 Image Quality</h4>
                                <ul>
                                    <li>High contrast, clear text</li>
                                    <li>Good lighting, no shadows</li>
                                    <li>Straight, horizontal alignment</li>
                                    <li>High resolution (300+ DPI)</li>
                                </ul>
                            </div>
                            <div>
                                <h4>📄 PDF Tips</h4>
                                <ul>
                                    <li>Text-based PDFs work best</li>
                                    <li>Simple table layouts</li>
                                    <li>Avoid complex formatting</li>
                                    <li>One table per page ideal</li>
                                </ul>
                            </div>
                            <div>
                                <h4>🎯 Data Structure</h4>
                                <ul>
                                    <li>Well names in first column</li>
                                    <li>Clear parameter headers</li>
                                    <li>Consistent number formats</li>
                                    <li>Avoid merged cells</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render with new React 18 API
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(SimpleOCRTest));
    </script>
</body>
</html>